# Deployment Files

This directory contains all files needed to deploy the Agar Web Scraper to production.

## Contents

### Documentation
- **[QUICKSTART.md](QUICKSTART.md)** - Quick deployment guide (10 steps)
- **[../docs/LIGHTSAIL_DEPLOYMENT.md](../docs/LIGHTSAIL_DEPLOYMENT.md)** - Complete deployment guide

### Configuration Files
- **[production.env](production.env)** - Production environment template
- **[../docker-compose.prod.yml](../docker-compose.prod.yml)** - Production Docker Compose

### Scripts
All scripts in `scripts/` directory:

- **generate_secret.py** - Generate secure SECRET_KEY and passwords
- **deploy.sh** - Automated deployment script
- **test_deployment.sh** - Test all endpoints and services
- **monitor.sh** - Health monitoring script
- **backup.sh** - Database and data backup script

### Nginx Configuration
Files in `nginx/` directory:

- **askagar.conf** - Main Nginx reverse proxy config
- **ui-nginx.conf** - UI container Nginx config

### Systemd Service
Files in `systemd/` directory:

- **agar-scraper.service** - Auto-start service on boot

## Quick Deploy

From the project root on your LightSail instance:

```bash
# 1. Configure environment
cp deployment/production.env .env
python3 deployment/scripts/generate_secret.py
nano .env  # Update with generated secrets

# 2. Deploy
./deployment/scripts/deploy.sh

# 3. Test
./deployment/scripts/test_deployment.sh
```

## Setup Auto-Start

To make the scraper start automatically on boot:

```bash
sudo cp deployment/systemd/agar-scraper.service /etc/systemd/system/
sudo systemctl enable agar-scraper
sudo systemctl start agar-scraper
```

Check status:
```bash
sudo systemctl status agar-scraper
```

## Setup Monitoring

Add monitoring to crontab to run every 5 minutes:

```bash
crontab -e
```

Add this line:
```
*/5 * * * * /home/ubuntu/apps/agar-scraper/deployment/scripts/monitor.sh
```

## Setup Daily Backups

Add backup to crontab to run daily at 2 AM:

```bash
crontab -e
```

Add this line:
```
0 2 * * * /home/ubuntu/apps/agar-scraper/deployment/scripts/backup.sh
```

## Environment Variables

Critical variables to set in `.env`:

### Security
- `SECRET_KEY` - Generate with generate_secret.py
- `POSTGRES_PASSWORD` - Generate with generate_secret.py

### AWS S3
- `S3_ACCESS_KEY_ID` - Your AWS access key
- `S3_SECRET_ACCESS_KEY` - Your AWS secret key
- `S3_BUCKET_NAME` - Usually "agar-documentation"
- `S3_REGION` - Usually "ap-southeast-2"

### CORS
- `CORS_ORIGINS` - Your domain(s), comma-separated

## File Permissions

Scripts should be executable:

```bash
chmod +x deployment/scripts/*.sh
chmod +x deployment/scripts/*.py
```

## Security Notes

1. **Never commit .env to git** - It contains secrets
2. **Use strong passwords** - Generated by generate_secret.py
3. **Restrict file permissions** - `chmod 600 .env`
4. **Rotate secrets periodically** - Every 90 days recommended
5. **Use minimal AWS IAM permissions** - Only S3 write to specific bucket

## Troubleshooting

### Scripts won't run
```bash
chmod +x deployment/scripts/*.sh
```

### Can't find docker-compose
```bash
sudo apt install docker-compose -y
```

### Permission denied
Make sure you're in the docker group:
```bash
sudo usermod -aG docker $USER
# Log out and back in
```

### Services won't start
Check logs:
```bash
docker-compose -f docker-compose.prod.yml logs
```

## Support

For detailed deployment instructions, see:
- [Quick Start Guide](QUICKSTART.md)
- [Complete Deployment Guide](../docs/LIGHTSAIL_DEPLOYMENT.md)
